const synthetics = require('Synthetics');
const log = require('SyntheticsLogger');

const pageLoadBlueprint = async function () {

    const HOSTNAME = process.env.API_HOSTNAME;
    const PATH = process.env.API_PATH || "/";
    const URL = `https://${HOSTNAME}${PATH}`;

    log.info('Check URL: ${URL}');

    let page = await synthetics.getPage();
    await page.setViewport({ width: 1920, height: 1080 });

    const client = await page.target().createCDPSession();
    await client.send('Security.setIgnoreCertificateErrors', {ignore: true});

    const response = await page.goto(URL, {waitUntil: 'domcontentloaded', timeout: 30000});
  
    if (!response) { 
        throw "Failed to load page! No response received."; 
    }
  
    const status = response.status();
    log.info(`Response Status: ${status}`);
    
    if (status < 200 || status > 299) {
        throw `Failed to load page! Status Code: ${status}`;
    }
    
    await synthetics.takeScreenshot('loaded', 'loaded');
};

exports.handler = async () => {
    return await pageLoadBlueprint();
};
